# DDM Local

This is a delay driven multipath (DDM) platform implementation for local and
integration testing purposes. It allows multiple DDM instances to execute, peer
and exchange routing information on a single illumos-based system. DDM local
does not modify any underlying routing table state, it is strictly for testing
the protocol plane, and external integration with DDM. DDM local works by
setting up and connecting [simnet](https://zinascii.com/2019/simnet-basics.html)
links between routers. DDM local should automatically clean up these interfaces
when a router is shut down.

A diagram of how control plane software might use the admin API of a DDM router
is depicted below.

```
┌ ─ ─ ─ ─ ─ ─ ─ ─ ┐               ┌ ─ ─ ─ ─ ─ ─ ─ ─ ┐
  server 1                          server 2         
│                 │               │                 │
   ┌─────────┐       ┌─────────┐      ┌─────────┐    
│  │ Server  │    │  │ Transit │  │   │ Server  │   │
   │ Router  │◀─────▶│ Router  │◀────▶│ Router  │    
│  └─────────┘    │  └─────────┘  │   └─────────┘   │
        ▲                                  ▲         
│       │         │               │        │        │
        │ advertise-prefix            ┌─────────┐    
│       │ get-peers               │   │ Control │   │
        │ get-prefixes                │  Plane  │    
│       │ get-routes              │   │Software │   │
        │                             └─────────┘    
│  ┌─────────┐    │               │                 │
   │ Control │                                       
│  │  Plane  │    │               │                 │
   │Software │                                       
│  └─────────┘    │               │                 │
 ─ ─ ─ ─ ─ ─ ─ ─ ─                 ─ ─ ─ ─ ─ ─ ─ ─ ─ 
```

## Usage

DDM routers come in two types

- Server: routers that run on servers.
- Transit: routers that run on dedicated routing hardware.

The primary distinction between these two types is that servers are sources and
destinations for L3 traffic, while L3 traffic strictly passes through transit
routers and is never destined to or sourced from a transit router.

When using DDM local, transit routers must be started first, then server routers
can connect to them. The following example starts a single transit router and
connects two server routers to it.

```shell
# optional to see debugging messages
export RUST_LOG=debug

# run a transit router with id=1 listening on management port 8001 with 2 ports
ddm-local 1 8001 transit 2

# run a server router with id=2 listening on management port 8002 connected to
# port 0 of the transit router. The 1 in 1:0 is is from the transit router id
# above.
ddm-local 2 8002 server 1:0

# run a server router with id=3 listening on management port 8003 connected to
# port 1 of the transit router.
ddm-local 3 8003 server 1:1
```

At this point the routers should be running and peered. We can look at this with
[`ddmadm`](/ddmadm).

```shell
# show peers seen by the transit router
ddmadm -p 8001 get-peers
```
```
{
    "3": PeerStatus {
        addr: Some(
            fe80::bcec:2fff:feeb:b28e,
        ),
        kind: Some(
            Server,
        ),
        name: Some(
            "han",
        ),
    }, "4": PeerStatus {
        addr: Some(
            fe80::dcc1:58ff:fed8:db03,
        ),
        kind: Some(
            Server,
        ),
        name: Some(
            "han",
        ),
    },
}
```

The name that you see in the output will correspond to the host name of the
machine you are running on. The `fe80` link-local addresses are automatically
generated by the operating system and will vary.

Link-local addresses used only for peering purposes. The basic job of the DDM
protocol-plane is to distribute routable prefixes among sever peers.  There are
no routable prefixes yet because we have not told a router to advertise
anything. We can do that through `ddmadm` which uses the router's management
API.

```
# Advertise a prefix originating from the first server router
ddmadm -p 8002 advertise-prefix fd00:1701:d::/64
```

This prefix will automatically propagate through the transit router and show up
at the second server router

```
# Ask the second server router for the prefixes it knows about
ddmadm -p 8002 get-prefixes
```
```
[
    DdmPrefix {
        origin: "han",
        prefixes: [
            Ipv6Prefix {
                addr: fd00:1701:d::,
                mask: 64,
            },
        ],
        serial: 0,
    },
]
```

The `ddmadm` CLI tool is using the [Rust client bindings](/ddm-admin-client) for
the [DDM OpenAPI spec](/ddm-openapi) spec.
